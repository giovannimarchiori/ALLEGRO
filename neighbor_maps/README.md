# Recipes to update the neighbor maps for topo clustering

The maps can be generated by executing the neighbours.py script with

`k4run neighbours.py`

One can configure which detectors to include in the map via the command line options `ecalb`, `ecalec`, `hcalb`, `hcalec`
Other options can be used to decide:
* if diagonal neighbours should be included (options `diagonal-ecal`, `diagonal-hcal`)
* if neighbours between ecal and hcal (option `link-calos`), between ecal barrel and endcap (option `link-ecal`), betwen hcal barrel and endcap (option `link-hcal`) should be included.

To create a global map for the four subdetectors with links among them the syntax is thus

`k4run neighbours.py --ecalb --ecalec --hcalb --hcalec --link-calos --link-ecal --link-hcal`

For debugging, i.e. to compare two map files (number of entries and content), the script [compareMaps.py](https://github.com/giovannimarchiori/ALLEGRO/blob/main/utils/compareMaps.py) in ../utils can be used, with

`python ../utils/compareMaps.py neighbours <file1.root> <file2.root>`


The script uses the CreateFCCeeCaloNeighbours algorithm implemented in [CreateFCCeeCaloNeighbours.h](https://github.com/HEP-FCC/k4RecCalorimeter/blob/main/RecFCCeeCalorimeter/src/components/CreateFCCeeCaloNeighbours.h) and [CreateFCCeeCaloNeighbours.cpp](https://github.com/HEP-FCC/k4RecCalorimeter/blob/main/RecFCCeeCalorimeter/src/components/CreateFCCeeCaloNeighbours.cpp).
The algorithm itself relies on the methods returning number of cells and neighbour lists within a given readout for the various segmentation classes om [DetUtils_k4geo.cpp](https://github.com/key4hep/k4geo/blob/main/detectorCommon/src/DetUtils_k4geo.cpp) and some additional logic to find neighbours among different segmentations (e.g. barrel vs endcap, or ecal vs hcal).

TODO:
* understand why neighbour map for HCAL is slightly different from the one in central repository (-> recent small HCAL modifications to fix overlaps?)
* understand why code crashes with --link-ecal option